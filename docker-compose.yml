services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443" # 開啟 HTTPS 端口
      - "--providers.file.filename=/etc/traefik/traefik_dynamic.yml" # 讀取憑證配置
    ports:
      - "80:80"
      - "443:443" # 映射 443
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./certs:/etc/traefik/certs:ro" # 掛載憑證
      - "./traefik_dynamic.yml:/etc/traefik/traefik_dynamic.yml:ro"
    networks:
      - openclaw_net
    restart: unless-stopped

  openclaw:
    image: node:22-slim
    container_name: openclaw_gateway
    working_dir: /app
    volumes:
      - ./data:/root/.openclaw
      - ./gog-config:/root/.config/gogcli
      - ./start-openclaw.sh:/start-openclaw.sh:ro
      # Skills 已經在 data/workspace/skills 內，不需要重複掛載
    environment:
      # 基礎配置
      - TZ=Asia/Taipei
      - OPENCLAW_GATEWAY_TOKEN=robby12345
      - OPENCLAW_GATEWAY_PORT=18789
      # AI 模型配置
      - MODEL=${MODEL:-anthropic/claude-3-5-haiku-20241022}
      # AI 引擎
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Skills 配置
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - NOTION_API_KEY=${NOTION_API_KEY:-}
      # Google Workspace
      - GOG_KEYRING_PASSWORD=${GOG_KEYRING_PASSWORD:-}
      - GOG_ACCOUNT=${GOG_ACCOUNT:-}
      # 通訊頻道
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      # 網絡配置
      - CF_TUNNEL_TOKEN=${CF_TUNNEL_TOKEN:-}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openclaw.rule=Host(`openclaw.local`) || Host(`localhost`)"
      - "traefik.http.routers.openclaw.entrypoints=websecure" # 強制走 HTTPS
      - "traefik.http.routers.openclaw.tls=true" # 啟用 TLS
      - "traefik.http.services.openclaw.loadbalancer.server.port=18790"
    command: /start-openclaw.sh
    restart: unless-stopped
    networks:
      - openclaw_net

  # Telegram Bot - 已禁用（OpenClaw 内置 Telegram 支持，不需要额外容器）
  # 如需启用独立 bot，取消注释以下内容并停用 OpenClaw 的 Telegram plugin
  # telegram-bot:
  #   build: ./telegram-bot
  #   container_name: telegram_bot
  #   environment:
  #     - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
  #     - OPENCLAW_GATEWAY_URL=http://openclaw:18790
  #     - OPENCLAW_GATEWAY_TOKEN=robby12345
  #     - OPENCLAW_AGENT=main
  #     - TZ=Asia/Taipei
  #   restart: unless-stopped
  #   networks:
  #     - openclaw_net
  #   depends_on:
  #     - openclaw

  # Cloudflare Tunnel - 安全遠端訪問（按需啟動）
  # cloudflared:
  #   image: cloudflare/cloudflared:latest
  #   container_name: cf_tunnel
  #   command: tunnel run --token ${CF_TUNNEL_TOKEN}
  #   environment:
  #     - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
  #   networks:
  #     - openclaw_net
  #   restart: unless-stopped
  #   profiles:
  #     - remote-access

networks:
  openclaw_net:
    driver: bridge